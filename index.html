<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>レジシステム統合</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      height: 100%;
      overflow: hidden; /* 全体スクロール禁止 */
      width: 100%;
    }
    body {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="h-full bg-gray-100">

  <!-- 全体コンテナ -->
  <div class="w-full h-full max-w-4xl mx-auto bg-white shadow-2xl rounded-lg flex flex-col min-h-0">

    <!-- レジ1: 商品選択 -->
    <div id="screen1" class="w-full h-full hidden flex flex-col">
      <header class="bg-gray-800 text-white p-4 flex justify-between items-center flex-shrink-0">
        <h1 class="text-xl font-bold">レジ1：商品選択</h1>
        <button onclick="proceedToPayment()"
                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">
          会計へ進む
        </button>
      </header>

      <main class="flex-grow p-4 grid grid-cols-1 md:grid-cols-3 gap-4 min-h-0">
        <!-- 左側: 商品一覧 -->
        <div class="md:col-span-2 bg-white p-4 rounded-lg shadow">
          <h2 class="text-lg font-bold border-b pb-2 mb-4">商品一覧</h2>
          <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <!-- 商品カードはJSでここに追加 -->
          </div>
        </div>

        <!-- 右側: ご注文内容 -->
        <div class="md:col-span-1 bg-gray-100 p-4 rounded-lg flex flex-col min-h-0">
          <h2 class="flex-shrink-0 text-lg font-bold border-b pb-2 mb-4">ご注文内容</h2>

          <!-- ご注文リスト（スクロール可） -->
          <div id="cart-items"
               class="flex-grow overflow-y-auto no-scrollbar space-y-2 min-h-0 allow-scroll"
               style="-webkit-overflow-scrolling: touch;">
            <p class="text-gray-500">商品が選択されていません。</p>
          </div>

          <!-- 下部パネル -->
          <div class="flex-shrink-0 mt-3 space-y-2">
            <button id="apply-discount" 
                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition">
              無料券を使う
            </button>
            <button id="clear-cart" 
                    class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">
              ご注文を削除
            </button>
            <div class="text-right text-xl font-bold">合計: <span id="total-amount">¥0</span></div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // ===== レジ1専用スクリプト =====

      // 商品データ例（後で商品管理と連携可能）
      const products = [
        { id: 1, name: "りんご", price: 100, flavor: "" },
        { id: 2, name: "ジュース", price: 150, flavor: "オレンジ" },
        { id: 3, name: "パン", price: 200, flavor: "" },
      ];

      let cart = [];
      let discountCount = 0;

      const productListEl = document.getElementById("product-list");
      const cartItemsEl = document.getElementById("cart-items");
      const totalAmountEl = document.getElementById("total-amount");

      // 商品一覧を表示
      function renderProducts() {
        productListEl.innerHTML = "";
        products.forEach(product => {
          const card = document.createElement("div");
          card.className = "p-3 border rounded-lg shadow hover:bg-gray-50 cursor-pointer";
          card.innerHTML = `
            <div class="font-bold">${product.name}</div>
            <div class="text-sm text-gray-500">${product.flavor || ""}</div>
            <div class="text-gray-800">¥${product.price}</div>
          `;
          card.onclick = () => addToCart(product);
          productListEl.appendChild(card);
        });
      }

      // カートに追加
      function addToCart(product) {
        const item = cart.find(i => i.id === product.id);
        if (item) {
          item.quantity++;
        } else {
          cart.push({ ...product, quantity: 1, discount: 0 });
        }
        renderCart();
      }

      // カートを表示
      function renderCart() {
        cartItemsEl.innerHTML = "";
        if (cart.length === 0) {
          cartItemsEl.innerHTML = `<p class="text-gray-500">商品が選択されていません。</p>`;
          totalAmountEl.textContent = "¥0";
          return;
        }

        cart.forEach(item => {
          const row = document.createElement("div");
          row.className = "p-2 border rounded bg-white";

          row.innerHTML = `
            <div class="flex justify-between">
              <span class="font-bold">${item.name}</span>
              <span class="font-bold">¥${item.price}</span>
            </div>
            <div class="text-sm text-gray-500">${item.flavor || ""}</div>
            <div class="flex items-center justify-between mt-1 text-sm">
              <span>数量: ${item.quantity} │ 券: ${item.discount}</span>
              <div class="space-x-1">
                <button class="px-2 py-1 bg-gray-200 rounded">－</button>
                <button class="px-2 py-1 bg-gray-200 rounded">＋</button>
                <button class="px-2 py-1 bg-red-400 text-white rounded">×</button>
              </div>
            </div>
          `;

          const [btnMinus, btnPlus, btnRemove] = row.querySelectorAll("button");
          btnMinus.onclick = () => { if (item.quantity > 1) item.quantity--; else cart = cart.filter(i => i.id !== item.id); renderCart(); };
          btnPlus.onclick = () => { item.quantity++; renderCart(); };
          btnRemove.onclick = () => { cart = cart.filter(i => i.id !== item.id); renderCart(); };

          cartItemsEl.appendChild(row);
        });

        updateTotal();
      }

      // 合計金額を計算
      function updateTotal() {
        let total = 0;
        cart.forEach(item => {
          total += item.price * item.quantity;
          total -= item.discount * item.price; // 割引適用
        });
        totalAmountEl.textContent = "¥" + total;
      }

      // 無料券を適用
      document.getElementById("apply-discount").onclick = () => {
        if (cart.length === 0) return alert("商品がありません");
        const target = cart[0]; // とりあえず最初の商品に適用
        if (target.discount < target.quantity) {
          target.discount++;
          renderCart();
        } else {
          alert("これ以上無料券を使えません");
        }
      };

      // カートをクリア
      document.getElementById("clear-cart").onclick = () => {
        cart = [];
        renderCart();
      };

      // レジ2へ進む
      function proceedToPayment() {
        if (cart.length === 0) {
          alert("商品がありません");
          return;
        }
        localStorage.setItem("cart", JSON.stringify(cart));
        showScreen("screen2");
      }

      // 初期化
      renderProducts();
      renderCart();
    </script>

    <!-- レジ2: お支払い -->
    <div id="screen2" class="w-full h-full hidden flex flex-col">
      <!-- ここにレジ2の中身を入れる -->
    </div>

    <!-- レジ3: お会計完了 -->
    <div id="screen3" class="w-full h-full hidden flex flex-col">
      <!-- ここにレジ3の中身を入れる -->
    </div>

    <!-- レジ4: 商品管理 -->
    <div id="screen4" class="w-full h-full hidden flex flex-col">
      <!-- ここにレジ4の中身を入れる -->
    </div>

    <!-- レジ5: 取引履歴 -->
    <div id="screen5" class="w-full h-full hidden flex flex-col">
      <!-- ここにレジ5の中身を入れる -->
    </div>

  </div>

  <!-- 共通スクリプト -->
  <script>
    // 初期表示
    document.addEventListener("DOMContentLoaded", () => {
      showScreen("screen1");
    });

    // 画面切り替え関数
    function showScreen(id) {
      document.querySelectorAll("body > div > div").forEach(div => div.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    // ===== 全画面スクロール禁止 =====
    document.body.addEventListener("touchmove", function(e) {
      if (!e.target.closest(".allow-scroll")) {
        e.preventDefault();
      }
    }, { passive: false });

    // ===== ダブルタップ拡大禁止 =====
    let lastTouchEnd = 0;
    document.addEventListener("touchend", function (event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });
  </script>
</body>
</html>
